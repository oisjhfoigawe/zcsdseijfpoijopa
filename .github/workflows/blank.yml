name: VS Code on Cloud (Fixed Password)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server and cloudflared
        run: |
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone --prefix=/tmp/code-server
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin

      - name: Generate Password and Start Services
        id: start
        run: |
          # --- „Éë„Çπ„ÉØ„Éº„ÉâÁîüÊàê ---
          PASSWORD=$(openssl rand -hex 16)
          echo "GENERATED_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # --- VS CodeËµ∑Âãï ---
          # [ÈáçË¶Å‰øÆÊ≠£] „Ç≥„Éû„É≥„Éâ„ÅÆÂâç„Å´ PASSWORD="$PASSWORD" „ÇíË®òËø∞„Åó„ÄÅ
          # Áí∞Â¢ÉÂ§âÊï∞„Å®„Åó„Å¶Ê≠£„Åó„ÅèÊ∏°„Åô„Çà„ÅÜ„Å´„Åó„Åæ„Åó„Åü
          PASSWORD="$PASSWORD" /tmp/code-server/bin/code-server --bind-addr 0.0.0.0:8080 --auth password &
          
          # --- Cloudflare TunnelËµ∑Âãï ---
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &

          echo "Waiting for tunnel URL..."

          # --- URLÂæÖÊ©ü ---
          timeout 60 bash -c 'until grep -m 1 -E "https://.*\.trycloudflare\.com" tunnel.log; do sleep 1; done' || {
            echo "‚ùå Error: Tunnel URL did not appear within 60 seconds."
            tail -n 30 tunnel.log
            exit 1
          }

          URL=$(grep -m 1 -E "https://.*\.trycloudflare\.com" tunnel.log | grep -oE 'https://[^[:space:]]+')

          # --- ÁµêÊûúË°®Á§∫ ---
          echo ""
          echo "=========================================="
          echo "Access URL & Info"
          echo "=========================================="
          echo "üîí Password: $PASSWORD"
          echo "üîó URL: $URL"
          echo "=========================================="
          echo ""

      - name: Keep Alive
        if: success()
        run: |
          for i in {1..360}; do
            echo "Keeping workflow alive... ($i/360 min)"
            sleep 60
          done
