name: VS Code on Cloud (Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server and cloudflared
        run: |
          # 1. code-serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone --prefix=/tmp/code-server

          # 2. cloudflaredã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin

      - name: Generate Password and Start Services
        id: start
        run: |
          # --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ ---
          PASSWORD=$(openssl rand -hex 16)
          echo "GENERATED_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # --- VS Codeèµ·å‹• ---
          /tmp/code-server/bin/code-server --bind-addr 0.0.0.0:8080 --auth password $PASSWORD &
          
          # --- Cloudflare Tunnelèµ·å‹• ---
          # ãƒ­ã‚°ã‚’tunnel.logã«å‡ºåŠ›
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &

          echo "Waiting for tunnel connection..."
          
          # --- URLå–å¾—ã®å¾…æ©Ÿãƒ­ã‚¸ãƒƒã‚¯ (ã“ã“ãŒé‡è¦) ---
          # ãƒˆãƒ³ãƒãƒ«ãŒç¢ºç«‹ã•ã‚Œã€ãƒ­ã‚°ã« 'trycloudflare.com' ãŒå«ã¾ã‚Œã‚‹ã¾ã§æœ€å¤§60ç§’å¾…ã¤
          # åˆ©ç”¨è¦ç´„ã®URLãªã©ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€æ­£ã—ã„URLã®ã¿ã‚’æŠ½å‡ºã—ã¾ã™
          for i in {1..60}; do
            if grep -q "trycloudflare.com" tunnel.log; then
              echo "Tunnel established!"
              break
            fi
            sleep 1
          done

          # --- URLã®æŠ½å‡º ---
          # 'trycloudflare.com' ã‚’å«ã‚€è¡Œã‹ã‚‰ã€https://... ã®éƒ¨åˆ†ã ã‘ã‚’åˆ‡ã‚Šå‡ºã™
          URL=$(grep "trycloudflare.com" tunnel.log | grep -oE 'https://[^[:space:]]+' | head -n 1)

          # --- çµæœè¡¨ç¤º ---
          echo ""
          echo "=========================================="
          echo "Access URL & Info"
          echo "=========================================="
          
          if [ -z "$URL" ]; then
            echo "âš ï¸ Error: Could not retrieve tunnel URL."
            echo "--- Debug Log (last 20 lines) ---"
            tail -n 20 tunnel.log
            echo "-----------------------------------"
            exit 1
          fi

          echo "ğŸ”’ Password: $PASSWORD"
          echo "ğŸ”— URL: $URL"
          echo "=========================================="
          echo ""

      - name: Keep Alive
        if: success()
        run: |
          # ã‚¸ãƒ§ãƒ–ã‚’ç¶­æŒ
          for i in {1..360}; do
            echo "Keeping workflow alive... ($i/360 min)"
            sleep 60
          done
