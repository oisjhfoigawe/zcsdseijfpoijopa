name: VS Code on Cloud (Strict Check)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server and cloudflared
        run: |
          # 1. code-serverã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -fsSL https://code-server.dev/install.sh | sh -s -- --method=standalone --prefix=/tmp/code-server

          # 2. cloudflaredã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin

      - name: Generate Password and Start Services
        id: start
        run: |
          # --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ ---
          PASSWORD=$(openssl rand -hex 16)
          echo "GENERATED_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          # --- VS Codeèµ·å‹• ---
          /tmp/code-server/bin/code-server --bind-addr 0.0.0.0:8080 --auth password $PASSWORD &
          
          # --- Cloudflare Tunnelèµ·å‹• ---
          # ãƒ­ã‚°ã‚’tunnel.logã«å‡ºåŠ›
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &

          echo "Waiting for tunnel URL..."

          # --- ã“ã“ãŒä¿®æ­£ç‚¹ ---
          # ã€Œhttps://...trycloudflare.comã€ã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãƒ­ã‚°ã«å‡ºã‚‹ã¾ã§æœ€å¤§60ç§’å¾…ã¡ã¾ã™
          # grepã§ -m 1 (æœ€åˆã®1ä»¶) ã¨ -E (æ­£è¦è¡¨ç¾) ã‚’ä½¿ã£ã¦å³å¯†ã«URLã‚’å¾…ã¡ã¾ã™
          timeout 60 bash -c 'until grep -m 1 -E "https://.*\.trycloudflare\.com" tunnel.log; do sleep 1; done' || {
            echo "âŒ Error: Tunnel URL did not appear within 60 seconds."
            echo "--- Debug Log (last 30 lines) ---"
            tail -n 30 tunnel.log
            echo "-----------------------------------"
            echo "The connection might be blocked or timed out."
            exit 1
          }

          # --- URLã®æŠ½å‡º ---
          # ãƒ­ã‚°ã‹ã‚‰URLéƒ¨åˆ†ã ã‘ã‚’åˆ‡ã‚Šå‡ºã—
          URL=$(grep -m 1 -E "https://.*\.trycloudflare\.com" tunnel.log | grep -oE 'https://[^[:space:]]+')

          # --- çµæœè¡¨ç¤º ---
          echo ""
          echo "=========================================="
          echo "Access URL & Info"
          echo "=========================================="
          echo "ğŸ”’ Password: $PASSWORD"
          echo "ğŸ”— URL: $URL"
          echo "=========================================="
          echo ""

      - name: Keep Alive
        if: success()
        run: |
          for i in {1..360}; do
            echo "Keeping workflow alive... ($i/360 min)"
            sleep 60
          done
